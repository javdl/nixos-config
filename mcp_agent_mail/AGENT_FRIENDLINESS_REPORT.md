# Agent-Friendliness Report: MCP Agent Mail

**Bead ID**: bd-3ik
**Date**: 2026-01-25
**Agent**: Claude Opus 4.5

## Executive Summary

**Status: HIGH AGENT-FRIENDLINESS MATURITY**

MCP Agent Mail is well-optimized for AI coding agent usage:
- TOON output integrated as optional envelope over MCP JSON
- Comprehensive AGENTS.md documentation (27KB)
- Python FastMCP server with full MCP protocol compliance
- Tool and resource format parameters for output control

## 1. Current State Assessment

### 1.1 Protocol Overview

MCP Agent Mail is an MCP server (JSON-RPC over HTTP). The MCP protocol requires JSON transport, so TOON is delivered inside a JSON envelope:

```json
{
  "format": "toon",
  "data": "<TOON encoded payload>",
  "meta": {
    "requested": "toon",
    "source": "param|default|implicit",
    "encoder": "tru",
    "toon_stats": { ... }
  }
}
```

### 1.2 Output Format Support

| Feature | Status | Details |
|---------|--------|---------|
| Tool `format` param | YES | `json` or `toon` |
| Resource `?format` query | YES | Query param on all resources |
| `MCP_AGENT_MAIL_OUTPUT_FORMAT` env | YES | Default format |
| `TOON_DEFAULT_FORMAT` env | YES | Fallback default |
| `TOON_BIN` env | YES | Custom encoder path |
| `TOON_STATS` env | YES | Enable encoding statistics |

### 1.3 Format Resolution Precedence

1. Tool/resource `format` parameter
2. `MCP_AGENT_MAIL_OUTPUT_FORMAT` environment variable
3. `TOON_DEFAULT_FORMAT` environment variable
4. Fallback to `json`

### 1.4 TOON Encoder Behavior

- Uses `tru` (toon_rust) encoder exclusively
- Node `toon` encoder is explicitly rejected
- Validates encoder via `--help`/`--version` check
- Graceful fallback to JSON on encoder failure

### 1.5 MCP Tools with Format Support

| Tool | Format Support | Notes |
|------|----------------|-------|
| `health_check` | YES | Basic connectivity |
| `ensure_project` | YES | Project creation |
| `register_agent` | YES | Agent registration |
| `fetch_inbox` | YES | Message retrieval |
| `send_message` | YES | Message sending |
| `file_reservation_paths` | YES | File locking |
| All other tools | YES | Consistent format parameter |

## 2. Documentation Assessment

### 2.1 AGENTS.md

**Status**: EXISTS and comprehensive (27KB)

Contains:
- Rule 1: Absolute file deletion protection
- Irreversible git/filesystem action guidelines
- Python/uv/FastMCP best practices
- SQLModel/SQLAlchemy async guidelines
- TOON integration context

### 2.2 Additional Documentation

- README.md: 130KB comprehensive guide
- RESEARCH_FINDINGS.md: 4.2KB TOON integration documentation
- SKILL.md: 13KB skill specification
- third_party_docs/: FastMCP and MCP protocol references

## 3. Scorecard

| Dimension | Score (1-5) | Notes |
|-----------|-------------|-------|
| Documentation | 5 | Comprehensive AGENTS.md + research docs |
| MCP Compliance | 5 | Full MCP protocol implementation |
| TOON Integration | 5 | Envelope format with proper fallback |
| Error Handling | 4 | Graceful fallback on encoder failure |
| Consistency | 5 | Unified format resolution across tools |
| Zero-shot Usability | 4 | MCP tools well-documented |
| **Overall** | **4.7** | Excellent maturity |

## 4. TOON Integration Status

**Status: FULLY INTEGRATED**

From RESEARCH_FINDINGS.md:
- `_apply_tool_output_format()` for tool outputs
- `_apply_resource_output_format()` for resource outputs
- `_normalize_output_format()` validates format values
- `_resolve_output_format()` handles precedence
- `_encode_payload_to_toon_sync()` performs encoding
- `_looks_like_toon_rust_encoder()` validates encoder

Test coverage:
- `tests/test_toon_formatting.py` - Unit tests
- `tests/e2e/test_toon_format_e2e.py` - E2E tests

## 5. MCP Protocol Constraints

- MCP is JSON-RPC over HTTP; responses must remain JSON
- TOON is delivered inside the JSON envelope (never raw TOON)
- Resources require `?format=toon` query parameter
- Tools accept `format` parameter in request

## 6. Recommendations

### 6.1 High Priority (P1)

None - mcp_agent_mail is already highly agent-friendly

### 6.2 Medium Priority (P2)

1. Verify all docs reference `tru` (not `tr`) for TOON encoder
2. Expand real-world test fixtures

### 6.3 Low Priority (P3)

1. Add JSON Schema for envelope format
2. Document token savings statistics

## 7. Conclusion

MCP Agent Mail is among the most agent-friendly tools in the suite with:
- Full TOON integration (envelope format)
- Comprehensive documentation
- Consistent format resolution
- Proper encoder validation and fallback

Score: **4.7/5** - Excellent maturity, minimal improvements needed.

---
*Generated by Claude Opus 4.5 during bd-3ik execution*
