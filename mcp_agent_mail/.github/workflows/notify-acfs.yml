# installer-notify.yml
# Copy this to .github/workflows/ in your project
# Notifies ACFS when install.sh changes
#
# Setup:
# 1. Create a GitHub PAT with `repo` scope
# 2. Add it as ACFS_DISPATCH_TOKEN secret in your repo
# 3. Copy this file to .github/workflows/

name: Notify ACFS of Installer Change

on:
  push:
    branches: [main, master]
    paths:
      - 'install.sh'
      - 'scripts/install.sh'
      - '**/install.sh'
  pull_request:
    branches: [main, master]
    paths:
      - 'install.sh'
      - 'scripts/install.sh'
      - '**/install.sh'

concurrency:
  group: installer-notify-${{ github.ref }}
  cancel-in-progress: true

jobs:
  notify-acfs:
    # Only notify on push to main, not PRs
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Compute installer SHA256
        id: checksum
        run: |
          # Find the installer file
          if [ -f install.sh ]; then
            INSTALLER_PATH="install.sh"
          elif [ -f scripts/install.sh ]; then
            INSTALLER_PATH="scripts/install.sh"
          else
            echo "No installer found"
            exit 1
          fi

          SHA256=$(sha256sum "$INSTALLER_PATH" | cut -d' ' -f1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "Computed SHA256: $SHA256"

      - name: Notify ACFS
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.ACFS_DISPATCH_TOKEN }}
          repository: Dicklesworthstone/agentic_coding_flywheel_setup
          event-type: installer-updated
          client-payload: |
            {
              "tool": "${{ github.event.repository.name }}",
              "repo": "${{ github.repository }}",
              "commit": "${{ github.sha }}",
              "new_sha256": "${{ steps.checksum.outputs.sha256 }}",
              "ref": "${{ github.ref }}",
              "actor": "${{ github.actor }}"
            }

      - name: Log notification
        run: |
          echo "::notice::Notified ACFS about installer change"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "SHA256: ${{ steps.checksum.outputs.sha256 }}"

  # Validate installer syntax on PRs
  validate-installer:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Shellcheck installer
        run: |
          EXIT_CODE=0
          for script in install.sh scripts/install.sh; do
            if [ -f "$script" ]; then
              echo "Checking $script..."
              shellcheck "$script" || EXIT_CODE=1
            fi
          done
          exit $EXIT_CODE
