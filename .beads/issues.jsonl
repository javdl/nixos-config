{"id":"bd-2pl","title":"Switch gemini-cli from source build to pre-built gemini.js bundle","description":"The current gemini-cli overlay in flake.nix uses overrideAttrs with fetchNpmDeps, patching node-pty, ripgrep paths, and auto-update settings. This is fragile and slow.\n\nGoogle publishes a bundled gemini.js (~24MB) on GitHub releases that just needs node to run:\nhttps://github.com/google-gemini/gemini-cli/releases/download/v0.29.5/gemini.js\n\nSwitch to downloading gemini.js and wrapping it with a shell script that runs 'node gemini.js', similar to how other tools use pre-built binaries. This eliminates fetchNpmDeps, postPatch, and preConfigure phases.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-22T13:32:40.165408289Z","created_by":"joost","updated_at":"2026-02-22T19:31:49.587919165Z","closed_at":"2026-02-22T19:31:49.587866025Z","close_reason":"done","source_repo":".","compaction_level":0,"original_size":0}
{"id":"nixos-config-24x","title":"Add molly-guard to prevent accidental shutdown/reboot via SSH","description":"Prevents accidental shutdown/reboot when connected via SSH by requiring you to type the hostname to confirm.\n\n**Features:**\n- Intercepts shutdown, reboot, halt, poweroff commands\n- Requires typing hostname to confirm when connected via SSH\n- Simple safety net for remote servers\n\n**Implementation:** services.molly-guard.enable = true;\n\n**Target:** hosts/hetzner-dev.nix","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-26T16:32:28.235052Z","created_by":"Joost van der Laan","updated_at":"2026-01-27T22:06:24.429637Z","closed_at":"2026-01-27T21:22:05.212743756Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["epic:hardening","server-ops"],"dependencies":[{"issue_id":"nixos-config-24x","depends_on_id":"nixos-config-x4e","type":"child","created_at":"2026-01-27T21:03:02.876256967Z","created_by":"Joost van der Laan","metadata":"{}","thread_id":""}]}
{"id":"nixos-config-395","title":"Add enhanced sysctl tuning with BBR congestion control","description":"Enhance kernel parameters for better performance.\n\n**Additions to existing sysctl config:**\n- net.ipv4.tcp_congestion_control = bbr (faster TCP)\n- net.core.rmem_max / wmem_max (larger buffers)\n- kernel.pid_max = 4194303 (64-bit max)\n- kern.maxproc = 65536\n\n**Source:** https://github.com/ghuntley/loom/blob/main/infra/nixos-modules/sysctl.nix\n\n**Target:** hosts/hetzner-dev.nix (merge with existing sysctl)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-26T16:32:52.508390Z","created_by":"Joost van der Laan","updated_at":"2026-01-27T22:06:24.430968Z","closed_at":"2026-01-27T21:37:35.387824382Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["epic:hardening","performance"],"dependencies":[{"issue_id":"nixos-config-395","depends_on_id":"nixos-config-x4e","type":"child","created_at":"2026-01-27T21:03:33.887942063Z","created_by":"Joost van der Laan","metadata":"{}","thread_id":""}]}
{"id":"nixos-config-3hf","title":"Improve loop.sh cross-platform portability","description":"## Portability issues between macOS and Linux\n\n### 4. BSD vs GNU date (lines 408, 709, 892)\n`date -Iseconds` is GNU-specific and fails on macOS.\n```bash\n# Fix: Use portable format\ndate -u +\"%Y-%m-%dT%H:%M:%SZ\"\n\n# Or create wrapper function:\niso_date() {\n    date -u +\"%Y-%m-%dT%H:%M:%S%z\" 2>/dev/null || date -Iseconds\n}\n```\n\n### 5. stat differences (line 153)\nCurrent approach tries both but logs errors.\n```bash\n# Fix: Detect once at startup\nif stat -f%z /dev/null &>/dev/null; then\n    STAT_SIZE=\"stat -f%z\"\nelse\n    STAT_SIZE=\"stat -c%s\"\nfi\n```\n\n### 6. bc dependency (lines 343-346, 354, 617, 620)\n`bc` may not be installed everywhere.\n```bash\n# Option A: Add to dependency check\ncommand -v bc &>/dev/null || { log ERROR \"bc required\"; exit 1; }\n\n# Option B: Use awk instead\nawk \"BEGIN  $num/1000\"\n```\n\n## Acceptance Criteria\n- [ ] Script runs on both macOS and Linux without errors\n- [ ] No stderr noise from platform detection\n- [ ] Missing dependencies caught early with clear message","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-27T20:45:47.806625Z","created_by":"joost","updated_at":"2026-01-27T20:45:47.806625Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"nixos-config-3km","title":"Enable nix-ld for running dynamically linked binaries","description":"Enable nix-ld to run dynamically linked non-Nix executables (AppImages, prebuilt binaries, etc.).\n\n**Features:**\n- Runs binaries that expect FHS paths\n- No need for patchelf or steam-run\n- Useful for downloaded tools, AppImages\n\n**Source:** https://github.com/ghuntley/loom/blob/main/infra/nixos-modules/base.nix\n\n**Implementation:** Single line - programs.nix-ld.enable = true;\n\n**Target:** hosts/hetzner-dev.nix","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-26T16:32:39.492894Z","created_by":"Joost van der Laan","updated_at":"2026-01-27T22:06:24.431824Z","closed_at":"2026-01-27T21:24:18.348650425Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["epic:hardening","quick-win"],"dependencies":[{"issue_id":"nixos-config-3km","depends_on_id":"nixos-config-x4e","type":"child","created_at":"2026-01-27T21:03:21.608044389Z","created_by":"Joost van der Laan","metadata":"{}","thread_id":""}]}
{"id":"nixos-config-3ld","title":"Integrate repo_updater (ru) into Hetzner dev box","description":"Plan: Create modules/repo-updater.nix (NixOS module packaging ru v1.2.1 from GitHub, systemd service+timer running as user joost every 6h, writes Nix-managed repo list to ~/.config/ru/repos.d/nix-managed.txt, user can add more repos imperatively). Modify hosts/hetzner-dev.nix to import module and configure with projectsDir=/home/joost/code. Ref: https://github.com/Dicklesworthstone/repo_updater","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-30T09:51:30.283561Z","created_by":"Joost van der Laan","updated_at":"2026-02-05T19:18:23.890062Z","closed_at":"2026-01-30T14:22:27.256363Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"nixos-config-43b","title":"Enhance Tailscale config with IPv6 forwarding for exit node","description":"Enable IPv6 forwarding for Tailscale exit node capability.\n\n**Addition:**\n- boot.kernel.sysctl.\"net.ipv6.conf.all.forwarding\" = \"1\"\n\n**Source:** https://github.com/ghuntley/loom/blob/main/infra/nixos-modules/tailscale.nix\n\n**Use case:** Use hetzner-dev as exit node for other devices\n\n**Target:** hosts/hetzner-dev.nix","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-26T16:33:09.510463Z","created_by":"Joost van der Laan","updated_at":"2026-01-27T22:06:24.432542Z","closed_at":"2026-01-27T21:45:39.052054352Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["epic:hardening","networking"],"dependencies":[{"issue_id":"nixos-config-43b","depends_on_id":"nixos-config-395","type":"blocks","created_at":"2026-01-27T20:29:54.202404Z","created_by":"joost","metadata":"{}","thread_id":""},{"issue_id":"nixos-config-43b","depends_on_id":"nixos-config-x4e","type":"child","created_at":"2026-01-27T21:03:46.916762200Z","created_by":"Joost van der Laan","metadata":"{}","thread_id":""}]}
{"id":"nixos-config-5cu","title":"Add K3s lightweight Kubernetes support","description":"Optional: Set up k3s for container orchestration beyond Docker.\n\n**Features:**\n- Lightweight Kubernetes (single binary)\n- Optional Traefik ingress (can disable)\n- GHCR image pull secrets support\n- Namespace setup automation\n\n**Source:** https://github.com/ghuntley/loom/blob/main/infra/nixos-modules/k3s.nix\n\n**Use case:** Running coding agents in isolated pods, container orchestration\n\n**Target:** modules/k3s.nix (optional, only if needed)","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-26T16:33:03.842947Z","created_by":"Joost van der Laan","updated_at":"2026-01-27T22:06:24.433250Z","closed_at":"2026-01-27T21:49:51.264572795Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["container","epic:containers"],"dependencies":[{"issue_id":"nixos-config-5cu","depends_on_id":"nixos-config-7rd","type":"blocks","created_at":"2026-01-27T20:29:56.366482Z","created_by":"joost","metadata":"{}","thread_id":""},{"issue_id":"nixos-config-5cu","depends_on_id":"nixos-config-fdo","type":"blocks","created_at":"2026-01-27T21:10:03.089151931Z","created_by":"Joost van der Laan","metadata":"{}","thread_id":""},{"issue_id":"nixos-config-5cu","depends_on_id":"nixos-config-x4e","type":"child","created_at":"2026-01-27T21:03:59.341782954Z","created_by":"Joost van der Laan","metadata":"{}","thread_id":""}]}
{"id":"nixos-config-7jr","title":"Add additional Nix binary caches","description":"Add nix-community binary cache to speed up builds.\n\n**Current state (in modules/cachix.nix):**\n- ✅ cache.nixos.org (already configured)\n- ✅ javdl-nixos-config.cachix.org (already configured)\n- ✅ devenv.cachix.org (already configured)\n- ❌ nix-community.cachix.org (MISSING - to add)\n\n**Implementation:**\nAdd to modules/cachix.nix substituters:\n- https://nix-community.cachix.org\n\nAdd to trusted-public-keys:\n- nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=\n\n**Note:** Original task mentioned devenv.cachix.org but it's already configured.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-26T16:33:03.390446Z","created_by":"Joost van der Laan","updated_at":"2026-01-27T22:06:24.433995Z","closed_at":"2026-01-27T21:39:24.118169027Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["epic:foundation","performance"],"dependencies":[{"issue_id":"nixos-config-7jr","depends_on_id":"nixos-config-x4e","type":"child","created_at":"2026-01-27T21:03:40.388922751Z","created_by":"Joost van der Laan","metadata":"{}","thread_id":""}]}
{"id":"nixos-config-7rd","title":"Add Podman as Docker alternative","description":"Optional: Set up Podman for rootless containers.\n\n**Features:**\n- Docker-compatible CLI\n- Rootless containers (better security)\n- No daemon required\n- Nix-built image loading\n\n**Source:** https://github.com/ghuntley/loom/blob/main/infra/nixos-modules/podman.nix\n\n**Use case:** Alternative to Docker with better security model\n\n**Target:** modules/podman.nix (optional, only if needed)","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-26T16:33:04.316397Z","created_by":"Joost van der Laan","updated_at":"2026-01-27T22:06:24.434671Z","closed_at":"2026-01-27T21:48:32.207340059Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["container","epic:containers"],"dependencies":[{"issue_id":"nixos-config-7rd","depends_on_id":"nixos-config-x4e","type":"child","created_at":"2026-01-27T21:03:53.236293752Z","created_by":"Joost van der Laan","metadata":"{}","thread_id":""}]}
{"id":"nixos-config-7xx","title":"Implement security audit module with auditd","description":"Set up comprehensive system auditing with auditd.\n\n**Features:**\n- Monitor execve syscalls (process execution)\n- Watch sensitive files (/etc/passwd, /etc/shadow, /etc/sudoers)\n- Monitor SSH keys and config changes\n- Track network/time changes\n- Kernel module loading/unloading\n- Mount operations\n- Log rotation\n\n**Source:** https://github.com/ghuntley/loom/blob/main/infra/nixos-modules/security-audit.nix\n\n**Target:** modules/security-audit.nix","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-26T16:32:52.036538Z","created_by":"Joost van der Laan","updated_at":"2026-01-27T22:06:24.435331Z","closed_at":"2026-01-27T21:42:07.157358821Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["epic:hardening","security"],"dependencies":[{"issue_id":"nixos-config-7xx","depends_on_id":"nixos-config-x4e","type":"child","created_at":"2026-01-27T21:02:56.619153131Z","created_by":"Joost van der Laan","metadata":"{}","thread_id":""}]}
{"id":"nixos-config-9ys","title":"Implement disk-based automatic Nix garbage collection","description":"Port the disk-based GC module from loom repo. Unlike time-based GC, this checks disk space first and only runs when available space falls below a threshold.\n\n**Features:**\n- Configurable disk threshold (default 50 GiB)\n- Maximum freed space per run\n- Preserve recent generations (e.g., 14d)\n- Low priority (nice 19, idle I/O)\n- Randomized delay to avoid thundering herd\n\n**Source:** https://github.com/ghuntley/loom/blob/main/infra/nixos-modules/automatic-nix-gc.nix\n\n**Target:** modules/automatic-nix-gc.nix + enable in hosts/hetzner-dev.nix","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-26T16:32:27.316267Z","created_by":"Joost van der Laan","updated_at":"2026-01-27T22:06:24.435970Z","closed_at":"2026-01-27T21:32:42.159159776Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["epic:maintenance","server-ops"],"dependencies":[{"issue_id":"nixos-config-9ys","depends_on_id":"nixos-config-x4e","type":"child","created_at":"2026-01-27T21:03:09.232003954Z","created_by":"Joost van der Laan","metadata":"{}","thread_id":""}]}
{"id":"nixos-config-b8u","title":"Fix ai.cachix.org key without corresponding substituter URL","description":"The modules/cachix.nix file has ai.cachix.org-1:... in trusted-public-keys but no corresponding https://ai.cachix.org URL in substituters. Either add the URL or remove the unused key.\n\n**Location:** modules/cachix.nix:21\n\n**Options:**\n1. Add 'https://ai.cachix.org' to substituters if the cache is needed\n2. Remove the ai.cachix.org-1 key if not used\n\n**Labels:** quick-win, cleanup","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-27T21:10:18.794734522Z","created_by":"Joost van der Laan","updated_at":"2026-01-27T21:39:30.361346537Z","closed_at":"2026-01-27T21:39:30.361346537Z","close_reason":"Removed unused ai.cachix.org key that had no corresponding substituter URL","source_repo":".","compaction_level":0,"original_size":0,"labels":["cleanup"]}
{"id":"nixos-config-ck3","title":"Enable VS Code Server for remote development","description":"Enable the vscode-server NixOS service for seamless VS Code Remote SSH development.\n\n**Features:**\n- Native VS Code Remote SSH support\n- No manual server installation needed\n- Auto-updates with system\n\n**Source:** https://github.com/ghuntley/loom/blob/main/infra/nixos-modules/vscode-server.nix\n\n**Implementation:** Single line - services.vscode-server.enable = true;\n\n**Target:** hosts/hetzner-dev.nix","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-26T16:32:38.583596Z","created_by":"Joost van der Laan","updated_at":"2026-01-26T19:36:12.840753Z","closed_at":"2026-01-26T19:36:12.840753Z","source_repo":".","deleted_at":"2026-01-26T19:36:12.840753Z","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task","compaction_level":0,"original_size":0}
{"id":"nixos-config-d34","title":"Epic: System Maintenance & Automation","description":"Automated maintenance tasks: disk-based garbage collection, auto-update from git. These reduce manual maintenance burden.","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-01-27T20:29:31.139540Z","created_by":"joost","updated_at":"2026-01-27T20:30:55.407324Z","closed_at":"2026-01-27T20:30:55.407324Z","close_reason":"Converted to labels on tasks (epic:foundation, epic:hardening, epic:maintenance, epic:containers)","source_repo":".","compaction_level":0,"original_size":0}
{"id":"nixos-config-e6e","title":"Fix critical bugs in loop.sh","description":"## Critical bugs that cause incorrect behavior\n\n### 1. Exit code propagation broken (line 555-584)\nPiping through `tee | while read` loses the exit code from `claude`.\n```bash\n# Current (broken):\ncat \"$prompt_file\" | claude ... | tee \"$temp_json\" | while IFS= read -r line; do\n\n# Fix: Use process substitution or capture exit via PIPESTATUS\n```\n\n### 2. Uninitialized CONFIG[verbose] (line 169)\n`CONFIG[verbose]` is referenced but never defined in the defaults array (lines 30-46).\n```bash\n# Add to CONFIG declaration:\n[verbose]=false\n```\n\n### 3. String vs numeric comparison (line 785)\n```bash\n# Current (fragile):\n[[ \"$ready_count\" == \"0\" ]]\n\n# Fix:\n[[ \"$ready_count\" -eq 0 ]] 2>/dev/null || [[ -z \"$ready_count\" ]]\n```\n\n## Acceptance Criteria\n- [ ] Claude exit codes propagate correctly\n- [ ] No \"unbound variable\" errors with verbose flag\n- [ ] Empty/zero ready_count handled correctly","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-27T20:45:44.491271Z","created_by":"joost","updated_at":"2026-01-27T20:53:17.631069Z","closed_at":"2026-01-27T20:53:17.631069Z","close_reason":"Fixed all 3 bugs: added [verbose]=false to CONFIG defaults, captured PIPESTATUS[1] for claude exit code propagation, and fixed ready_count comparison to handle empty/non-numeric values","source_repo":".","compaction_level":0,"original_size":0}
{"id":"nixos-config-fdo","title":"Implement SOPS secrets management with SSH host key","description":"Set up sops-nix for encrypted secrets using the SSH host key for decryption.\n\n**Features:**\n- Secrets encrypted at rest in git\n- Decrypts automatically on deploy using SSH host key\n- No separate age key needed\n- Per-machine secrets files\n\n**Source:** https://github.com/ghuntley/loom/blob/main/infra/nixos-modules/secrets.nix\n\n**Requirements:**\n- Add sops-nix to flake inputs\n- Create modules/secrets.nix\n- Set up secrets directory structure\n\n**Target:** modules/secrets.nix + update flake.nix","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-26T16:32:51.571711Z","created_by":"Joost van der Laan","updated_at":"2026-01-27T22:06:24.436603Z","closed_at":"2026-01-27T21:28:26.875390094Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["epic:foundation","security"],"dependencies":[{"issue_id":"nixos-config-fdo","depends_on_id":"nixos-config-x4e","type":"child","created_at":"2026-01-27T21:02:50.504790335Z","created_by":"Joost van der Laan","metadata":"{}","thread_id":""}]}
{"id":"nixos-config-i5b","title":"Fix SSH agent persistence on hetzner-dev server","description":"SSH agent stops working on the dev box (hetzner-dev), especially in new tmux sessions and after SSH disconnects. AI agents cannot push to git repos because SSH keys are unavailable.\n\nRoot cause: Server (home-manager-server.nix) has no local SSH agent — relies entirely on agent forwarding from macOS. When SSH connection drops or new tmux panes open without forwarding, SSH_AUTH_SOCK becomes invalid.\n\nFix requires four layers:\n1. systemd user service for ssh-agent (services.ssh-agent.enable)\n2. tmux update-environment for SSH_AUTH_SOCK propagation\n3. Shell fallback logic (fish + zsh) to prefer forwarded agent, fall back to systemd agent\n4. Auto-load SSH keys at boot via systemd oneshot service\n\nAll changes in users/joost/home-manager-server.nix","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-30T09:57:54.205537Z","created_by":"Joost van der Laan","updated_at":"2026-02-05T19:18:23.892355Z","closed_at":"2026-01-30T14:22:25.313335Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"nixos-config-k81","title":"Improve loop.sh reliability and portability","description":"## Summary\nReview identified 20 improvements for loop.sh, the production-grade Claude Code loop runner.\n\n## Critical Issues (High Priority)\n1. **Exit code propagation broken** (line 555-584) - Piping through `tee | while read` loses exit code from claude\n2. **Uninitialized CONFIG[verbose]** (line 169) - Referenced but not in defaults array\n3. **String vs numeric comparison** (line 785) - `[[ \"$ready_count\" == \"0\" ]]` should use `-eq`\n\n## Portability Issues (Medium Priority)\n4. **BSD vs GNU date** - `date -Iseconds` is GNU-specific, fails on macOS\n5. **stat differences** - Current fallback works but is noisy\n6. **bc dependency** - Not always installed; add check or use awk\n\n## Security & Robustness (Medium Priority)\n7. **json_escape incomplete** - Missing \\r, form feed, control chars; use `jq -Rs`\n8. **Missing mktemp error handling** (line 551)\n9. **Spinner orphan process** - If crash between start/stop, orphan remains\n\n## Functional Improvements (Low Priority)\n10. Add `--max-cost` option\n11. Add `--dry-run` mode\n12. Add `-p/--prompt FILE` for custom prompts\n13. Resume should restore config from state.json\n\n## Code Quality (Low Priority)\n14. TOML parser too simple (no arrays, inline comments)\n15. Magic numbers should be named constants\n16. Cache redundant git operations\n17. Inconsistent quoting of array subscripts\n18. Log rotation race condition\n19. Webhook fire-and-forget (no retry/logging)\n20. No version in state.json for migrations\n\n## Acceptance Criteria\n- [ ] Fix critical issues (1-3)\n- [ ] Address portability issues (4-6)\n- [ ] Improve robustness (7-9)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-27T20:43:00.532366Z","created_by":"joost","updated_at":"2026-01-27T20:44:33.066648Z","source_repo":".","compaction_level":0,"original_size":0,"dependencies":[{"issue_id":"nixos-config-k81","depends_on_id":"nixos-config-3hf","type":"blocks","created_at":"2026-01-27T20:46:15.566211Z","created_by":"joost","metadata":"{}","thread_id":""},{"issue_id":"nixos-config-k81","depends_on_id":"nixos-config-e6e","type":"blocks","created_at":"2026-01-27T20:46:15.505132Z","created_by":"joost","metadata":"{}","thread_id":""},{"issue_id":"nixos-config-k81","depends_on_id":"nixos-config-loc","type":"blocks","created_at":"2026-01-27T20:46:15.772095Z","created_by":"joost","metadata":"{}","thread_id":""},{"issue_id":"nixos-config-k81","depends_on_id":"nixos-config-nzo","type":"blocks","created_at":"2026-01-27T20:46:15.705585Z","created_by":"joost","metadata":"{}","thread_id":""},{"issue_id":"nixos-config-k81","depends_on_id":"nixos-config-ry2","type":"blocks","created_at":"2026-01-27T20:46:15.637893Z","created_by":"joost","metadata":"{}","thread_id":""}]}
{"id":"nixos-config-la9","title":"Implement NixOS auto-update from git","description":"Port the auto-update module from loom repo. Polls a git repository and automatically deploys NixOS configuration when changes are detected.\n\n**Features:**\n- Configurable git repo URL and branch\n- SSH key authentication support\n- Lock file to prevent concurrent updates\n- Tracks deployed revision to avoid re-deploys\n- Optional nix-output-monitor (nom) integration\n- Configurable poll interval\n\n**Source:** https://github.com/ghuntley/loom/blob/main/infra/nixos-modules/nixos-auto-update.nix\n\n**Target:** modules/nixos-auto-update.nix","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-26T16:32:27.773770Z","created_by":"Joost van der Laan","updated_at":"2026-01-27T22:06:24.437271Z","closed_at":"2026-01-27T21:36:01.362806182Z","source_repo":".","compaction_level":0,"original_size":0,"labels":["epic:maintenance","server-ops"],"dependencies":[{"issue_id":"nixos-config-la9","depends_on_id":"nixos-config-fdo","type":"blocks","created_at":"2026-01-27T20:29:55.303959Z","created_by":"joost","metadata":"{}","thread_id":""},{"issue_id":"nixos-config-la9","depends_on_id":"nixos-config-x4e","type":"child","created_at":"2026-01-27T21:03:15.470752393Z","created_by":"Joost van der Laan","metadata":"{}","thread_id":""}]}
{"id":"nixos-config-loc","title":"Clean up loop.sh code quality issues","description":"## Code quality and maintainability improvements\n\n### 14. TOML parser too simple (lines 992-1001)\nCurrent parser does not handle inline comments, arrays, or properly quoted values.\n- Option A: Document limitations clearly\n- Option B: Use external TOML parser if available\n- Option C: Switch to JSON config\n\n### 15. Magic numbers should be named constants\n```bash\n# Add near top of file:\nreadonly MAX_LOG_SIZE=10485760  # 10MB\nreadonly MAX_FILES_SHOWN=8\nreadonly DEFAULT_TERM_COLS=80\nreadonly DEFAULT_TERM_ROWS=24\n```\n\n### 16. Cache redundant git operations\n`git_branch` and `git_commit_short` called multiple times per iteration.\n```bash\n# At iteration start:\nlocal current_branch=$(git_branch)\nlocal current_commit=$(git_commit_short)\n# Use these throughout instead of calling functions\n```\n\n### 17. Inconsistent quoting of array subscripts\nSome use `${CONFIG[key]}`, others `${CONFIG[\"key\"]}`. Standardize.\n\n### 18. Log rotation race condition (line 153-154)\nMoving log while writing could lose data. Use copy+truncate instead:\n```bash\ncp \"$LOG_FILE\" \"$LOG_FILE.$(date +%s).bak\"\n: > \"$LOG_FILE\"\n```\n\n### 19. Webhook fire-and-forget (line 417)\nNo retry or error logging for failed webhooks. Add basic logging:\n```bash\ncurl ... || log DEBUG \"Webhook failed (non-critical)\"\n```\n\n### 20. No version in state.json\nAdd script version for future migration compatibility:\n```json\n{ \"version\": \"3.0.0\", ... }\n```\n\n## Acceptance Criteria\n- [ ] No magic numbers in code\n- [ ] Consistent code style\n- [ ] State file includes version","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-27T20:45:55.808451Z","created_by":"joost","updated_at":"2026-01-27T20:45:55.808451Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"nixos-config-m52","title":"Epic: Hetzner-dev Server Foundation","description":"Foundation tasks that enable other work: binary caches, secrets management. These should be completed first as they speed up builds and enable secure configuration.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-27T20:29:28.389569Z","created_by":"joost","updated_at":"2026-01-27T20:30:55.403919Z","closed_at":"2026-01-27T20:30:55.403919Z","close_reason":"Converted to labels on tasks (epic:foundation, epic:hardening, epic:maintenance, epic:containers)","source_repo":".","compaction_level":0,"original_size":0}
{"id":"nixos-config-nzo","title":"Add loop.sh feature flags (cost limit, dry-run, custom prompt)","description":"## New command-line options\n\n### 10. Add --max-cost option\nStop loop when cumulative cost exceeds threshold.\n```bash\n# In CONFIG defaults:\n[max_cost]=0  # 0 = unlimited\n\n# In parse_args:\n--max-cost)\n    CONFIG[max_cost]=\"$2\"\n    shift 2 ;;\n\n# In main loop:\nif [[ $(bc <<< \"${STATE[total_cost]} >= ${CONFIG[max_cost]}\") -eq 1 ]]; then\n    log WARN \"Cost limit reached: \\$${STATE[total_cost]}\"\n    break\nfi\n```\n\n### 11. Add --dry-run mode\nShow what would happen without executing Claude.\n```bash\n# In CONFIG:\n[dry_run]=false\n\n# In run_iteration:\nif [[ \"${CONFIG[dry_run]}\" == true ]]; then\n    log INFO \"[DRY RUN] Would run: claude -p ... --model ${CONFIG[model]}\"\n    return 0\nfi\n```\n\n### 12. Add -p/--prompt FILE option\nAllow arbitrary prompt files instead of just PROMPT_build.md / PROMPT_plan.md.\n```bash\n# In CONFIG:\n[prompt_file]=\"\"\n\n# In parse_args:\n-p|--prompt)\n    CONFIG[prompt_file]=\"$2\"\n    shift 2 ;;\n\n# In main/run_iteration:\nlocal prompt_file=\"${CONFIG[prompt_file]:-PROMPT_${CONFIG[mode]}.md}\"\n```\n\n### 13. Resume should restore config\nCurrently session_load only restores STATE, not CONFIG.\n```bash\nsession_load() {\n    ...\n    # Restore config\n    CONFIG[mode]=$(jq -r '.config.mode' \"$session_file\")\n    CONFIG[model]=$(jq -r '.config.model' \"$session_file\")\n    CONFIG[max_iterations]=$(jq -r '.config.max_iterations' \"$session_file\")\n}\n```\n\n## Acceptance Criteria\n- [ ] --max-cost N stops at spending threshold\n- [ ] --dry-run shows planned actions without executing\n- [ ] -p FILE uses custom prompt\n- [ ] resume continues with same config as original session","status":"open","priority":3,"issue_type":"feature","created_at":"2026-01-27T20:45:54.945162Z","created_by":"joost","updated_at":"2026-01-27T20:45:54.945162Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"nixos-config-rjsh","title":"Add server config for rajesh","description":"Create NixOS server configuration for colleague rajesh, based on the existing loom server setup. Includes:\n- hosts/rajesh.nix (main server config)\n- hosts/hardware/rajesh.nix (hardware config with placeholder UUIDs)\n- users/rajesh/nixos.nix (NixOS user settings)\n- users/rajesh/home-manager-server.nix (home-manager config)\n- flake.nix entry for rajesh server","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T08:00:03Z","created_by":"Claude","updated_at":"2026-02-05T19:18:39.074857Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"nixos-config-ry2","title":"Harden loop.sh error handling and security","description":"Robustness and security improvements:\n\n7. json_escape incomplete (lines 360-367) - Missing carriage return, form feed, control chars. Use jq -Rs for proper escaping.\n\n8. Missing mktemp error handling (line 551) - Add error check after mktemp call.\n\n9. Spinner orphan process (lines 253-262) - Track PIDs in array, clean all in trap.\n\nAcceptance Criteria:\n- JSON with special characters encodes correctly\n- Temp file failures do not cause silent errors  \n- No orphan processes after any exit path","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-27T20:46:07.606879Z","created_by":"joost","updated_at":"2026-01-27T20:46:07.606879Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"nixos-config-whp","title":"Epic: Server Hardening & Security","description":"Security improvements and server hardening: molly-guard, nix-ld, sysctl tuning, security auditing. These improve the server's security posture and reliability.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-27T20:29:29.730507Z","created_by":"joost","updated_at":"2026-01-27T20:30:55.405497Z","closed_at":"2026-01-27T20:30:55.405497Z","close_reason":"Converted to labels on tasks (epic:foundation, epic:hardening, epic:maintenance, epic:containers)","source_repo":".","compaction_level":0,"original_size":0}
{"id":"nixos-config-wq0","title":"Epic: Container Orchestration (Optional)","description":"Optional container orchestration beyond Docker: Podman for rootless containers, K3s for Kubernetes. Only implement if needed for specific use cases.","status":"closed","priority":3,"issue_type":"epic","created_at":"2026-01-27T20:29:32.615838Z","created_by":"joost","updated_at":"2026-01-27T20:30:55.408599Z","closed_at":"2026-01-27T20:30:55.408599Z","close_reason":"Converted to labels on tasks (epic:foundation, epic:hardening, epic:maintenance, epic:containers)","source_repo":".","compaction_level":0,"original_size":0}
{"id":"nixos-config-wz9","title":"Add Fail2ban for SSH brute-force protection","description":"Enable fail2ban to protect against SSH brute-force attacks.\n\n**Features:**\n- Automatic IP banning on failed auth attempts\n- Configurable ban time and retry limits\n- Works with existing firewall\n\n**Source:** https://github.com/ghuntley/loom/blob/main/infra/nixos-modules/fail2ban.nix\n\n**Implementation:** Single line - services.fail2ban.enable = true;\n\n**Target:** hosts/hetzner-dev.nix","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-26T16:32:39.044128Z","created_by":"Joost van der Laan","updated_at":"2026-01-26T19:41:14.638571Z","closed_at":"2026-01-26T19:41:14.638571Z","source_repo":".","deleted_at":"2026-01-26T19:41:14.638571Z","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task","compaction_level":0,"original_size":0}
{"id":"nixos-config-x4e","title":"Hetzner Dev Server Hardening & Enhancement","description":"Epic covering all improvements to the hetzner-dev server configuration, including:\n\n**Security:**\n- SOPS secrets management\n- Security audit with auditd\n- molly-guard for SSH safety\n\n**Operations:**\n- Disk-based garbage collection\n- Auto-update from git\n- nix-ld for dynamic binaries\n\n**Performance:**\n- BBR congestion control and sysctl tuning\n- Additional binary caches\n\n**Networking:**\n- Tailscale IPv6 forwarding for exit node\n\n**Optional/Future:**\n- Podman (rootless containers)\n- K3s (lightweight Kubernetes)","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-27T21:02:37.826763614Z","created_by":"Joost van der Laan","updated_at":"2026-01-27T21:50:13.353909335Z","closed_at":"2026-01-27T21:50:13.353909335Z","close_reason":"All tasks completed: SOPS secrets, security audit, molly-guard, disk GC, auto-update, nix-ld, BBR tuning, caches, Tailscale exit node, Podman, and K3s modules.","source_repo":".","compaction_level":0,"original_size":0}
{"id":"nixos-dsm1","title":"Add server config for desmond","description":"Create NixOS server configuration for colleague desmond, based on the existing loom server setup. Includes:\n- hosts/desmond.nix (main server config)\n- hosts/hardware/desmond.nix (hardware config with placeholder UUIDs)\n- users/desmond/nixos.nix (NixOS user settings)\n- users/desmond/home-manager-server.nix (home-manager config)\n- flake.nix entry for desmond server","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T08:00:00Z","created_by":"Claude","updated_at":"2026-02-05T19:18:23.893342Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"nixos-jks1","title":"Add server config for jackson","description":"Create NixOS server configuration for colleague jackson, based on the existing loom server setup. Includes:\n- hosts/jackson.nix (main server config)\n- hosts/hardware/jackson.nix (hardware config with placeholder UUIDs)\n- users/jackson/nixos.nix (NixOS user settings)\n- users/jackson/home-manager-server.nix (home-manager config)\n- flake.nix entry for jackson server","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T08:00:01Z","created_by":"Claude","updated_at":"2026-02-05T19:18:23.893342Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"nixos-jvn1","title":"Add server config for jeevan","description":"Create NixOS server configuration for colleague jeevan, based on the existing loom server setup. Includes:\n- hosts/jeevan.nix (main server config)\n- hosts/hardware/jeevan.nix (hardware config with placeholder UUIDs)\n- users/jeevan/nixos.nix (NixOS user settings)\n- users/jeevan/home-manager-server.nix (home-manager config)\n- flake.nix entry for jeevan server","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T08:00:04Z","created_by":"Claude","updated_at":"2026-02-05T19:18:23.893342Z","source_repo":".","compaction_level":0,"original_size":0}
{"id":"nixos-ptr1","title":"Add server config for peter","description":"Create NixOS server configuration for colleague peter, based on the existing loom server setup. Includes:\n- hosts/peter.nix (main server config)\n- hosts/hardware/peter.nix (hardware config with placeholder UUIDs)\n- users/peter/nixos.nix (NixOS user settings)\n- users/peter/home-manager-server.nix (home-manager config)\n- flake.nix entry for peter server","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-05T08:00:02Z","created_by":"Claude","updated_at":"2026-02-05T19:18:23.893342Z","source_repo":".","compaction_level":0,"original_size":0}
